<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swipe Market</title>
    <link rel="stylesheet" href="../static/header.css">
    <link rel="stylesheet" href="../static/general.css">
    <link rel="stylesheet" href="../static/swipemarket.css">
    <link rel="stylesheet" href="../static/intermediate.css"> 
    <link rel="stylesheet" href="../static/phonestyles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@200..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <script>
    ;(function(){
      const saved = [];
      const orig = document.addEventListener;
      // override addEventListener
      document.addEventListener = function(type, fn, opts) {
        if (type === 'DOMContentLoaded') {
          saved.push(fn);
        } else {
          orig.call(this, type, fn, opts);
        }
      };
      // install one real listener
      orig.call(document, 'DOMContentLoaded', () => {
        saved.forEach(fn => {
          try { fn() } catch(e) { console.error(e) }
        });
      });
    })();
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D26R1LF247"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <div id="g_id_onload" data-client_id="362313378422-s5g6ki5lkph6vaeoad93lfirrtugvnfl.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false">
    </div>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-D26R1LF247');
    </script>
    <style>
    </style>
  </head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-V549ZYC27J"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-V549ZYC27J');
  </script>
  <body>
    <main>
      <p id="output"></p>
      <div class="top">
        <div class="top-left">
          <div id="current-time"></div>
          <a href="https://liondine.com" target="blank">&lt; Lion Dine</a>
        </div>
        <div class="top-right">
          <a href="https://forms.gle/7M3JpiJ9RoapZmxF6" target="blank" class="feedback">
            Feedback
          </a>
          <div class="signin-container">
            <div id="g_id_signin" class="g_id_signin" data-type="standard"></div>
          </div>
          <div id="profile-menu" class="profile-menu">
            <img id="profile-icon" src="" alt="Profile"/>
            <div id="profile-dropdown" class="profile-dropdown">
              <a href="/profile" class="dropdown-item">Profile</a>
              <button onclick="handleSignOut()">Sign Out</button>
            </div>
          </div>
        </div>
      </div>
      <header class="header" id="index-header">
        <a href="/">Swipe Market &#128722;</a> 
      </header>
      <div class="subheading">Marketplace for Columbia meal swipe exchanges</div>
      <div class="sell-button-container">
        <a href="/post_listings" class="post-button" id="postListingsButton">Post Listing</a>
        <button type="button" class="how-it-works-button" id="howItWorksButton">How It Works</button>
      </div>
      <div class="how-it-works-popup" id="howItWorksPopup">
        <div class="how-it-works-content">
          <p style="line-height: 1.6; text-align: justify;">
            <p>
              Swipe Market is an online marketplace that connects students 
              who want to buy, sell, and donate meal swipes. 
            </p>
            <ul>
              <li>
                Browse Listings: if you see a swipe below that you'd like to buy or sell, 
                click the "get swiped in" or "swipe them in" button to be 
                automatically put in touch with the person who posted it.
              </li>
              <li>
                Post Listing: if you'd like to add a listing to one of the tables 
                below, click the "post listing" button and fill out the 
                form. Potential buyers/sellers will then be able to contact you.
              </li>
              <li>
                Listings automatically expire once the end time has passed but you can edit and delete them at any time before then.
              </li>
            </ul>
            <p>
              Once we send an email connecting you to your buyer/seller, 
              it's up to you to coordinate a meeting and exchange payment 
              details. Good luck!
            </p>
          </p>
        </div>
      </div>
      <div class="tables-container">
      <table>
        <caption>Buy a Swipe 
        </caption> 
        <thead>
          <tr>
            <th>Dining Hall(s)</th>
            <th>Date</th>
            <th>Time</th>
            <th>You'll Pay</th>
            <th>Payment Methods</th>
            <th>Contact Seller</th>
          </tr>
        </thead>
        <tbody>
          {% for listing in seller_listings %}
          <tr>
            <td>{{ listing.dining_hall }}</td>
            <td>{{ listing.date }}</td>
            <td>{{ listing.start_time }} - {{ listing.end_time }}</td>
            <td>${{ "%.2f"|format(listing.price if listing.price is not none else 0) }}</td>
            <td>{{ listing.payment_methods }}</td>
            <td>
              <button type="button" class="contact-button" 
                      data-listing-id="{{ listing.id }}" 
                      data-listing-type="seller" 
                      onclick="openForm(this)">Get Swiped In</button>
              <!--delete button that only appears to poster-->
              <div class="listing-actions" data-owner-email="{{ listing.user.email }}">
                <button onclick="deleteListing('{{ listing.id }}', 'seller')" class="delete-button">X</button>
                <button onclick="editListing('{{ listing.id }}', 'seller')" class="edit-button">Edit</button>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6">Nothing available now - check back soon or post your own listing</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <table>
        <caption>Sell a Swipe</caption>
        <thead>
          <tr>
            <th>Dining Hall(s)</th>
            <th>Date</th>
            <th>Time</th>
            <th>You'll Earn</th>
            <th>Payment Methods</th>
            <th>Contact Buyer</th>
          </tr>
        </thead>
        <tbody>
          {% for listing in buyer_listings %}
          <tr>
            <td>{{ listing.dining_hall }}</td>
            <td>{{ listing.date }}</td>
            <td>{{ listing.start_time }} - {{ listing.end_time }}</td>
            <td>${{ "%.2f"|format(listing.price if listing.price is not none else 0) }}</td>
            <td>{{ listing.payment_methods }}</td>
            <td>
              <button type="button" class="contact-button" 
                      data-listing-id="{{ listing.id }}" 
                      data-listing-type="buyer" 
                      onclick="openForm(this)">Swipe Them In</button>
              <div class="listing-actions" data-owner-email="{{ listing.user.email }}">
                <button onclick="deleteListing('{{ listing.id }}', 'buyer')" class="delete-button">X</button>
                <button onclick="editListing('{{ listing.id }}', 'buyer')" class="edit-button">Edit</button>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6">Nothing available now - check back soon or post your own listing</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="form-popup" id="myForm">
      <form action="/send_connection_email" method="POST" class="form-container">
        <input type="hidden" name="listing_id" id="listing_id" value="">
        <input type="hidden" name="listing_type" id="listing_type" value="">
        <input type="hidden" name="sender_name" id="sender_name" value="">
        <input type="hidden" name="sender_email" id="sender_email" value="">
        <div>Click "Confirm" to receive an email putting you in touch with the person who posted this swipe.
        </div>
        <button type="submit" class="btn">Confirm</button>
        <button type="button" class="btn cancel" onclick="closeForm()">Cancel</button>
      </form>
    </div>
    <div class="footer"><p></p></div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="../static/functions.js" type="text/javascript"></script>
    <script src="../static/signin.js" type="text/javascript"></script>
    <script src="../static/forms.js" type="text/javascript"></script>
    <div id="popup" class="form-popup">
        <div class="form-container">
            <p id="popup-message">Connection email sent! Check your inbox</p>
        </div>
    </div>
  </body>
</html>
